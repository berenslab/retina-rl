Bootstrap: docker
From: nvidia/cuda:12.6.1-runtime-ubuntu22.04

%post

  export TZ=Europe/Berlin
  export DEBIAN_FRONTEND=noninteractive

#  # add repo for new python
#  apt update
#  apt install -y software-properties-common
#  add-apt-repository ppa:deadsnakes/ppa -y

  # Update
  apt -qy update

  # Python
  apt -y install python3 python3-all-dev pip

  # VizDoom Depends

  apt install -y \
    cmake \
    libboost-all-dev \
    libsdl2-dev \
    libfreetype6-dev \
    libgl1-mesa-dev \
    libglu1-mesa-dev \
    libpng-dev \
    libjpeg-dev \
    libbz2-dev \
    libfluidsynth-dev \
    libgme-dev \
    libopenal-dev \
    zlib1g-dev \
    timidity \
    git \
    tar \
    wget \
    unzip \
    gifsicle \
    parallel \
    nvidia-modprobe \
    nasm

  # Plotting Depends
  apt install -y \
    ffmpeg \
    python3-pyqt5 \
    libcairo2-dev \
    fonts-liberation


  # Rename python3 to python
  ln -s /usr/bin/python3 /usr/bin/python

  # install action code compiler
  wget https://zdoom.org/files/utils/acc/acc159linux-x64.zip
  mkdir /usr/share/acc
  unzip acc159linux-x64.zip -d /usr/share/acc
  mv /usr/share/acc/acc /usr/bin/acc

  # retinal-rl Extra

  pip3 install --no-cache-dir gymnasium==0.29.1 
  pip3 install --no-cache-dir torch==2.4.0 torchvision==0.19.0 #--index-url https://download.pytorch.org/whl/cu126
  pip3 install --no-cache-dir vizdoom==1.2.4 
  pip3 install --no-cache-dir matplotlib==3.9.1
  pip3 install --no-cache-dir opentsne==1.0.2
  pip3 install --no-cache-dir pygame==2.6.1
  pip3 install --no-cache-dir pycairo==1.26.1 
  pip3 install --no-cache-dir git+https://github.com/pytorch/captum.git@fd758e025673100cb6a525d59a78893c558b825b
  pip3 install --no-cache-dir torchinfo==1.8.0
  pip3 install --no-cache-dir num2words==0.5.13
  pip3 install --no-cache-dir omgifol==0.5.1
  pip3 install --no-cache-dir git+https://github.com/alex404/sample-factory.git@05465ef425530c3e2ef13dd1f9aa2d7313eb3d4a
  pip3 install --no-cache-dir dpcpp-cpp-rt==2024.2.1 
  pip3 install --no-cache-dir seaborn==0.13.2
  pip3 install --no-cache-dir hydra-core==1.3.2
  pip3 install --no-cache-dir networkx==3.3
  pip3 install --no-cache-dir pylint==3.3.1
  
  # Clean up for smaller container size
  rm acc159linux-x64.zip
  apt clean
  rm -rf /var/lib/apt/lists/*
  rm -rf /root/.cache/pip